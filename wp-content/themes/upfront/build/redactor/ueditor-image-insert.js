(function(e){define(["scripts/redactor/ueditor-insert","text!scripts/redactor/ueditor-templates.html"],function(t,n){var r=t.UeditorInsert.extend({$editor:!1,caption_active:!1,type:"image",className:"ueditor-insert upfront-inserted_image-wrapper",tpl:_.template(e(n).find("#image-insert-tpl").html()),resizable:!1,defaultData:{caption:"Default caption",show_caption:1,imageFull:{src:"",width:100,height:100},imageThumb:{src:"",width:100,height:100},selectedImage:{src:"",width:100,height:100},linkType:"do_nothing",linkUrl:"",isLocal:1,alignment:{vid:"center",label:"Center"},externalImage:{top:0,left:0,width:0,height:0},variant_id:"",style:{label_id:"",vid:"",caption:{order:1,height:50,width_cls:"",left_cls:"ml0",top_cls:"mt0",show:1},group:{"float":"none",width_cls:"",left_cls:"ml0",height:0,marginRight:0,marginLeft:0},image:{width_cls:"",left_cls:"ml0",top_cls:"mt0",src:"",height:0}}},events:{"click .ueditor-insert-remove":"click_remove"},get_caption_state:function(){return this.data.get("show_caption")?0:1},click_remove:function(e){e.preventDefault(),this.trigger("remove",this)},make_caption_editable:function(){var e=this,t=this.data.get("style"),n=this.$(".wp-caption-text");if(!t)return!1;if(!t.caption||!t.caption.show||this.$(".wp-caption-text").length===0)return;n.off("keyup").on("keyup",function(t){e.data.set("caption",this.innerHTML,{silent:!0}),e.data.trigger("update")}).ueditor({linebreaks:!1,autostart:!0,pastePlainText:!0,buttons:[],placeholder:e.defaultData.caption,inserts:[],focus:!1}).attr("contenteditable",!1),this.caption_ueditor=n.data("ueditor"),this.caption_ueditor.redactor.events.on("ueditor:change",function(t){e.data.set("caption",e.caption_ueditor.$el.html(),{silent:!0}),e.data.trigger("update")}),this.caption_ueditor.redactor.events.on("ueditor:focus",function(t){if(t!=e.caption_ueditor.redactor||e.caption_active===!0)return;var r=e.$el.closest(".redactor-editor"),i=r.data("ueditor"),s=i?i.redactor:!1;if(!s)return;t.$element.is(n)?(r.attr("contenteditable",!1),n.attr("contenteditable",!0),e.caption_active=!0):(r.attr("contenteditable",!0),n.attr("contenteditable",!1),e.caption_active=!1),s.$editor.off("drop.redactor paste.redactor keydown.redactor keyup.redactor focus.redactor blur.redactor"),s.$textarea.on("keydown.redactor-textarea")}),this.caption_ueditor.redactor.events.on("ueditor:blur",function(t){if(t!=e.caption_ueditor.redactor||e.caption_active===!1)return;var r=e.$el.closest(".redactor-editor"),i=r.data("ueditor"),s=i?i.redactor:!1;if(!s)return;t.$element.is(n)?(r.attr("contenteditable",!0),n.attr("contenteditable",!1),e.caption_active=!1):(r.attr("contenteditable",!1),n.attr("contenteditable",!0),e.caption_active=!0),s.build.setEvents()}),e.$el.on("hover, click",function(t){t.stopPropagation();var r=e.$el.closest(".redactor-editor");n.attr("contenteditable",!0),r.attr("contenteditable",!1),e.caption_active=!0}),setTimeout(function(){var t=e.$el.closest(".redactor-editor");t.on("mouseenter, click",function(r){n.attr("contenteditable",!1),t.attr("contenteditable",!0),e.caption_active=!1})},10)},controlEvents:function(){var e=this;this.stopListening(this.controls),this.listenTo(this.controls,"control:ok:link",function(e,t){var n=e.$("input[type=text]").val(),r=e.$("input[type=radio]:checked").val()||"do_nothing",i={};"external"===r&&!n.match(/https?:\/\//)&&!n.match(/\/\/:/)&&(n=n.match(/^www\./)||n.match(/\./)?"http://"+n:n),i={linkType:r,linkUrl:n},this.data.set(i),e.model.set(i),t.close()}),this.listenTo(this.controls,"control:click:toggle_caption",function(e){var t=1;this.data.get("show_caption")&&(t=0),this.data.set("show_caption",t)}),typeof this.control_events=="function"&&this.control_events()},updateControlsPosition:function(){var e=Upfront.Util.grid.col_to_width(this.data.get("style").group.width_cls),t=this.controls.$el,n=0;n=(e-t.width())/2,t.css("margin-left",n+"px")},getSimpleOutput:function(){var t=this.el.cloneNode(!0),n=this.data.toJSON();return n.image=this.get_proper_image(),this.data.set("width",this.$el.width(),{silent:!0}),this.data.trigger("update"),n.isLocal=parseInt(n.isLocal,10),t.innerHTML=this.tpl(n),e(t).width(this.data.get("width")),e("<div>").html(t).html()},get_proper_image:function(){var e=this.data.toJSON(),t=e.imageFull,n=Upfront.Settings.LayoutEditor.Grid;return e.style=e.style||{image_col:0,group:"",image:"",caption:""},e.imageThumb&&e.style&&e.style.image&&e.style.image.col&&e.style.image.col*n.column_width<=e.imageThumb.width&&(t=e.imageThumb),t},getOutput:function(){var t=this.el.cloneNode(),n=this.data.toJSON();return n.image=this.get_proper_image(),n.image?(this.data.set("width",this.$el.width(),{silent:!0}),this.data.trigger("update"),n.isLocal=parseInt(n.isLocal,10),t.innerHTML=this.tpl(n),e("<div>").html(t).html()):!1},getImageData:function(t){if(!t)return!1;var n=t.at(0).toJSON(),r=this.getSelectedImage(n),i=e.extend({},this.defaultData,{attachmentId:n.ID,title:n.post_tite,imageFull:n.image,imageThumb:this.getThumb(n.additional_sizes),selectedImage:_.isUndefined(n.selected_size)?n.image:_.filter(n.additional_sizes,function(e){var t=n.selected_size.toLowerCase().split("x"),r=t[0],i=t[1];return e.width==r&&e.height==i})[0],linkType:"do_nothing",linkUrl:"",align:"center"});return i},getThumb:function(e){var t={width:0};return _.each(e,function(e){e.width<=500&&e.width>t.width&&(t=e)}),t},getSelectedImage:function(e){if(e.selected_size=="full")return e.image;var t=e.selected_size?e.selected_size.split("x"):[];if(t.length!=2)return e.image;for(var n=0;n<e.additional_sizes.length;n++){var r=e.additional_sizes[n];if(r.width==t[0]&&r.height==t[1])return r}return e.image},importInserts:function(t,n,r){var i=this,s=t.find("img"),o={};return t.is(".wp-caption-text")||(this.$editor=t),s.each(function(){var t=e(this),s=t.closest(".upfront-inserted_image-wrapper"),u=!1;s.length?u=i.importFromWrapper(s,n,r):u=i.importFromImage(t),o[u.data.id]=u}),o},importFromWrapper:function(e,t,n){var r=e.attr("id"),s=!1,u=!1,a=!1,f=o;return _.contains(n,"postImage")&&(f=i),t[r]?s=new f({data:t[r]}):s=this.importFromImage(e.find("img")),s.render(),e.replaceWith(s.$el),s},getLinkView:function(){if(this.linkView)return this.linkView;var e=new u({data:{linkType:this.data.get("linkType"),linkUrl:this.data.get("linkUrl")}});return this.linkView=e,e},getStyleView:function(){if(this.styleView)return this.styleView;var e=new a(this.data);return this.styleView=e,e},calculateRealSize:function(e){var t=new Image;return t.src=e,{width:t.width,height:t.height}},generateThumbSrc:function(e,t){var n=this.data.get("imageFull").src,r=n.split("."),i=r.pop();return n=r.join(".")+"-"+e+"x"+t+"."+i,n},calculateImageResize:function(e,t){var n=t.width/t.height>e.width/e.height?"height":"width",r=t[n]/e[n],i={width:Math.round(t.width/r),height:Math.round(t.height/r)},s=n=="width";return i.top=s?-Math.round((i.height-e.height)/2):0,i.left=s?0:-Math.round((i.width-e.width)/2),i}}),i=r.extend({className:"ueditor-insert upfront-inserted_image-wrapper ueditor-insert-variant ueditor-post-image-insert",tpl:_.template(e(n).find("#post-image-insert-tpl").html()),init:function(){this.controlsData=[{id:"style",type:"dialog",icon:"style",tooltip:"Style",view:this.getStyleView()},{id:"link",type:"dialog",icon:"link",tooltip:"Link image",view:this.getLinkView()},{id:"toggle_caption",type:"simple",icon:"caption",tooltip:"Toggle Caption",active:_.bind(this.get_caption_state,this)}],this.createControls()},start:function(){var e=this,t=Upfront.Media.Manager.open({multiple_selection:!1});return t.done(function(t,n){var r=e.getImageData(n);r.id=e.data.id,e.data.clear({silent:!0}),r.variant_id=r.style.vid,e.data.set(r)}),t},render:function(){var t=_.extend({},this.defaultData,this.data.toJSON()),n=t.style;if(!n)return;t.style.label_id=t.style.label&&t.style.label.trim()!==""?"ueditor-image-style-"+t.style.label.toLowerCase().trim().replace(" ","-"):t.style.vid,t.image=this.get_proper_image(),t.show_caption==0&&(t.style.image.width_cls=Upfront.Settings.LayoutEditor.Grid.class+24);var r=this.$el.find(".ueditor-insert-variant-group"),i=Upfront.Behaviors.GridEditor,s=e(".upfront-content-marker-contents"),o=parseFloat(e(".upfront-content-marker-contents>*").css("padding-left"))/i.col_size,u=parseFloat(e(".upfront-content-marker-contents>*").css("padding-right"))/i.col_size,a=Upfront.Util.grid.width_to_col(s.width(),!0),f=a-o-u,l=e(".upfront-content-marker-contents>*").width()/f;o=o?parseInt(o):0,u=u?parseInt(u):0,n&&n.group&&n.group.float&&(n.group.float=="left"&&o>0?(t.style.group.marginLeft=(o-Math.abs(n.group.margin_left))*l,t.style.group.marginRight=0):n.group.float=="right"&&u>0?(t.style.group.marginRight=(u-Math.abs(n.group.margin_right))*l,t.style.group.marginLeft=0):n.group.float=="none"&&o>0&&(t.style.group.marginLeft=(o-Math.abs(n.group.margin_left)+Math.abs(n.group.left))*l,t.style.group.marginRight=0)),this.$el.html(this.tpl(t)),this.createControls(),this.controls.render(),this.$(".ueditor-insert-variant-group").append(this.controls.$el),this.make_caption_editable(),this.updateControlsPosition(),this.$(".ueditor-insert-variant-group").append('<a href="#" contenteditable="false" class="upfront-icon-button upfront-icon-button-delete ueditor-insert-remove"></a>')},control_events:function(){this.listenTo(this.controls,"control:ok:style",function(e,t){if(e._style){var n=e._style.toJSON();this.data.set("variant_id",e.variant_id),this.data.set("style",e._style.toJSON()),e.data.set("selected",e.variant_id)}t.close()})},importFromImage:function(t){var n=_.extend({},this.defaultData),r={src:t.attr("src"),width:t.width(),height:t.height()},s=e("<a>").attr("href",r.src)[0],o=this.calculateRealSize(r.src),u=t.closest(".ueditor-insert-variant-group"),a=u.attr("class"),f=u.find(".wp-caption-text"),l=f.attr("class"),c=u.find(".uinsert-image-wrapper"),h=c.attr("class"),p=1;s.origin!=window.location.origin&&(n.isLocal=0),this.calculateRealSize(r.src),n.imageThumb=r,n.imageFull={width:o.width,height:o.height,src:r.src};var d=t.parent();d.is("a")&&(n.linkUrl=d.attr("href"),n.linkType="external");var v=t.attr("class");v?(v=v.match(/wp-image-(\d+)/),v?n.attachmentId=v[1]:n.attachmentId=!1):n.attachmentId=!1,n.title=t.attr("title"),_.isEmpty(f.text())||(n.caption=f.html()),p=f.prev(c).length?1:0,f.length===0&&(p=1),u.length?(n.style={caption:{order:p,height:f.css("minHeight")?f.css("minHeight").replace("px",""):f.height(),width_cls:Upfront.Util.grid.derive_column_class(l),left_cls:Upfront.Util.grid.derive_marginleft_class(l),top_cls:Upfront.Util.grid.derive_margintop_class(l),show:f.length},group:{"float":u.css("float"),width_cls:Upfront.Util.grid.derive_column_class(a),left_cls:Upfront.Util.grid.derive_marginleft_class(a),height:u&&u.css("minHeight")?u.css("minHeight").replace("px",""):r.height+f.height(),marginRight:0,marginLeft:0},image:{width_cls:Upfront.Util.grid.derive_column_class(h),left_cls:Upfront.Util.grid.derive_marginleft_class(h),top_cls:Upfront.Util.grid.derive_margintop_class(h),src:"",height:0}},n.variant_id=u.data("variant")):(n.style=Upfront.Content.ImageVariants.first().toJSON(),n.variant_id=n.style.vid);var m=new i({data:n});return m.render(),t.replaceWith(m.$el),m}}),s=_([{vid:"center",label:"Center"},{vid:"left",label:"Left"},{vid:"right",label:"Right"}]),o=r.extend({className:"ueditor-insert upfront-inserted_image-wrapper upfront-inserted_image-basic-wrapper",create_controlls:function(e){this.controlsData=[{id:"link",type:"dialog",icon:"link",tooltip:"Link image",view:this.getLinkView()},{id:"toggle_caption",type:"simple",icon:"caption",tooltip:"Toggle Caption",active:_.bind(this.get_caption_state,this)}],this.allow_alignment(e)&&this.controlsData.unshift({id:"style",type:"dialog",icon:"style",tooltip:"Alignment",view:this.getStyleView()}),this.createControls()},start:function(e){var t=this,n=Upfront.Media.Manager.open({multiple_selection:!1});return n.done(function(n,r){var i=t.getImageData(r);i.id=t.data.id,t.data.clear({silent:!0}),i.style=t.defaultData.style,i.variant_id="basic-image",t.$editor=e.closest(".redactor-box"),t.data.set(i)}),n},render:function(){var t=_.extend({},this.defaultData,this.data.toJSON()),n=t.style,r=this.data.get("alignment");if(!n)return;t.style.label_id="ueditor-image-style-center",r&&(t.style.label_id="ueditor-image-style-"+r.vid,t.style.group.float=r.vid),t.image=this.get_proper_image(),t.style.group.width_cls=this.get_group_width_cls(t.image),t.show_caption==0&&(t.style.image.width_cls=Upfront.Settings.LayoutEditor.Grid.class+24);var i=this.$el.find(".ueditor-insert-variant-group"),s=Upfront.Behaviors.GridEditor,o=e(".upfront-content-marker-contents"),u=parseFloat(e(".upfront-content-marker-contents>*").css("padding-left"))/s.col_size,a=parseFloat(e(".upfront-content-marker-contents>*").css("padding-right"))/s.col_size,f=Upfront.Util.grid.width_to_col(o.width(),!0),l=f-u-a,c=e(".upfront-content-marker-contents>*").width()/l;u=u?parseInt(u):0,a=a?parseInt(a):0,n&&n.group&&n.group.float&&(n.group.float=="left"&&u>0?(t.style.group.marginLeft=(u-Math.abs(n.group.margin_left))*c,t.style.group.marginRight=0):n.group.float=="right"&&a>0?(t.style.group.marginRight=(a-Math.abs(n.group.margin_right))*c,t.style.group.marginLeft=0):n.group.float=="none"&&u>0&&(t.style.group.marginLeft=(u-Math.abs(n.group.margin_left)+Math.abs(n.group.left))*c,t.style.group.marginRight=0)),this.$el.html(this.tpl(t)),this.create_controlls(t.style.group.width_cls),this.controls.render(),this.$(".ueditor-insert-variant-group").append(this.controls.$el),this.make_caption_editable(),this.updateControlsPosition(),this.$(".ueditor-insert-variant-group").append('<a href="#" contenteditable="false" class="upfront-icon-button upfront-icon-button-delete ueditor-insert-remove"></a>')},allow_alignment:function(e){if(typeof e=="undefined")return!1;var t=parseInt(e.replace("c",""),10),n=Upfront.Util.grid.width_to_col(this.$editor.width());return t+2<=n},control_events:function(){var e=this;this.listenTo(this.controls,"control:ok:style",function(e,t){e._style&&(this.data.set("variant_id",e.variant_id),this.data.set("alignment",e._style),e.data.set("selected",e.variant_id)),t.close()})},get_group_width_cls:function(e){var t=Upfront.Util.grid.width_to_col(e.width),n=Upfront.Util.grid.width_to_col(this.$editor.width());return t+1<=n?Upfront.Settings.LayoutEditor.Grid.class+t:Upfront.Settings.LayoutEditor.Grid.class+n},get_proper_image:function(){var e=this.data.toJSON(),t=e.imageFull,n=Upfront.Settings.LayoutEditor.Grid,r=Upfront.Util.grid.width_to_col(this.$editor.width());return _.isEmpty(e.selectedImage.src)?t:e.selectedImage},importFromImage:function(t){var n=_.extend({},this.defaultData),r={src:t.attr("src"),width:t.width(),height:t.height()},i=e("<a>").attr("href",r.src)[0],u=this.calculateRealSize(r.src),a=t.closest(".ueditor-insert-variant-group"),f=a.attr("class"),l=a.find(".wp-caption-text"),c=l.attr("class"),h=a.find(".uinsert-image-wrapper"),p=h.attr("class");caption_order=1,i.origin!=window.location.origin&&(n.isLocal=0),n.imageThumb=r,n.imageFull={width:u.width,height:u.height,src:r.src};var d=t.parent();d.is("a")&&(n.linkUrl=d.attr("href"),n.linkType="external");var v=t.attr("class");v?(v=v.match(/wp-image-(\d+)/),v?n.attachmentId=v[1]:n.attachmentId=!1):n.attachmentId=!1,n.title=t.attr("title"),_.isEmpty(l.text())||(n.caption=l.html()),caption_order=l.prev(h).length?1:0,n.show_caption=l.length,a.length?(n.style={caption:{order:1,height:l.css("minHeight")?l.css("minHeight").replace("px",""):l.height(),width_cls:Upfront.Util.grid.derive_column_class(c),left_cls:Upfront.Util.grid.derive_marginleft_class(c),top_cls:Upfront.Util.grid.derive_margintop_class(c),show:l.length},group:{"float":a.css("float"),width_cls:Upfront.Util.grid.derive_column_class(f),left_cls:Upfront.Util.grid.derive_marginleft_class(f),height:a&&a.css("minHeight")?a.css("minHeight").replace("px",""):r.height+l.height(),marginRight:0,marginLeft:0},image:{width_cls:Upfront.Util.grid.derive_column_class(p),left_cls:Upfront.Util.grid.derive_marginleft_class(p),top_cls:Upfront.Util.grid.derive_margintop_class(p),src:"",height:0}},n.variant_id=a.data("variant"),n.variant_id&&(n.alignment=s.findWhere({vid:a.data("variant")}))):(n.alignment=s.first(),n.variant_id=n.alignment.vid);var m=new o({data:n});return m.render(),t.replaceWith(m.$el),m},getStyleView:function(){if(this.styleView)return this.styleView;var e=new f(this.data);return this.styleView=e,e},updateControlsPosition:function(){this.controls.$el.css({marginLeft:15,marginTop:15})}}),u=Backbone.View.extend({tpl:_.template(e(n).find("#image-link-tpl").html()),initialize:function(e){e.data&&(this.model=new Backbone.Model(e.data),this.listenTo(this.model,"change",this.render))},events:{"change input[type=radio]":"updateData"},render:function(){this.$el.width("200px");var e=this.model.toJSON();e.checked='checked="checked"',this.$el.html(this.tpl(e))},updateData:function(e){var t=this,n=this.$("input:checked").val(),r=this.$("#uinsert-image-link-url").val();if(n=="post"){var i={postTypes:this.postTypes()};Upfront.Views.Editor.PostSelector.open(i).done(function(e){t.model.set({linkType:"post",linkUrl:e.get("permalink")})})}else this.model.set({linkType:n,linkUrl:r})},postTypes:function(){var e=[];return _.each(Upfront.data.ugallery.postTypes,function(t){t.name!="attachment"&&e.push({name:t.name,label:t.label})}),e}}),a=Backbone.View.extend({tpl:_.template(e(n).find("#image-style-tpl").html()),initialize:function(e){this.data=new Backbone.Model,this.listenTo(this.data,"change",this.render),this.data.set("variants",Upfront.Content.ImageVariants.toJSON()),this.data.set("selected",e.get("variant_id"))},events:{"change input[type=radio]":"update_data","click input[type=radio]":"on_click"},render:function(){return this.$el.html(this.tpl({data:this.data.toJSON()})),this},on_click:function(e){e.stopPropagation()},update_data:function(t){t.stopPropagation(),this.variant_id=e(t.target).val(),this._style=Upfront.Content.ImageVariants.findWhere({vid:this.variant_id})}}),f=Backbone.View.extend({tpl:_.template(e(n).find("#image-style-tpl").html()),initialize:function(e){this.data=new Backbone.Model,this.listenTo(this.data,"change",this.render),this.data.set("variants",s.toArray()),this.data.set("selected",e.get("variant_id")?e.get("variant_id"):"center")},events:{"change input[type=radio]":"update_data","click input[type=radio]":"on_click"},render:function(){return this.$el.html(this.tpl({data:this.data.toJSON()})),this},on_click:function(e){e.stopPropagation()},update_data:function(t){t.stopPropagation(),this.variant_id=e(t.target).val(),this._style=s.findWhere({vid:this.variant_id})}});return{PostImageInsert:i,ImageInsert:o}})})(jQuery);